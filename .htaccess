# ==========================================
# Poshy Lifestyle Store – Apache Configuration
# DigitalOcean VPS Production
# ==========================================

# ─── Rewrite Engine ────────────────────────────────────────────────────
RewriteEngine On
RewriteBase /

# ─── Force HTTPS ──────────────────────────────────────────────────────
RewriteCond %{HTTPS} off
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ─── HTTP Security Headers ────────────────────────────────────────────
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    # Prevent MIME sniffing
    Header always set X-Content-Type-Options "nosniff"
    # XSS filter
    Header always set X-XSS-Protection "1; mode=block"
    # Referrer policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    # HSTS – tells browsers to always use HTTPS (6 months)
    Header always set Strict-Transport-Security "max-age=15768000; includeSubDomains"
    # Permissions policy – disable unused browser features
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    # Content Security Policy – allow Google/Facebook scripts needed for OAuth
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://accounts.google.com https://connect.facebook.net https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; frame-src https://accounts.google.com https://www.facebook.com; connect-src 'self' https://accounts.google.com https://graph.facebook.com"
    # Remove server fingerprinting
    Header unset X-Powered-By
    Header always unset X-Powered-By
</IfModule>

# ─── Security: Block sensitive files ───────────────────────────────────
<FilesMatch "\.(env|log|bak|sql|csv|md|py|sh)$">
    Require all denied
</FilesMatch>

<Files "config.php">
    Require all denied
</Files>

# Block access to sensitive file extensions
<FilesMatch "\.(env|log|bak|sql|csv|md|py|sh|ini)$">
    Require all denied
</FilesMatch>

# ─── Skip real files and directories ──────────────────────────────────
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# ─── Podcast URLs ────────────────────────────────────────────────────
# /podcast → podcast.php (listing)
# /podcast/my-episode-slug → podcast.php?slug=my-episode-slug
RewriteRule ^podcast/?$ podcast.php [L,QSA]
RewriteRule ^podcast/([a-z0-9]+(?:-[a-z0-9]+)*)/?$ podcast.php?slug=$1 [L,QSA]

# ─── Clean product URLs ──────────────────────────────────────────────
# /the-ordinary-retinol → product.php?slug=the-ordinary-retinol
RewriteRule ^([a-z0-9]+(?:-[a-z0-9]+)*)/?$ product.php?slug=$1 [L,QSA]

# ─── Large File Uploads (500 MB) ──────────────────────────────────────
<IfModule mod_php.c>
    php_value upload_max_filesize 500M
    php_value post_max_size 512M
    php_value max_execution_time 600
    php_value max_input_time 600
    php_value memory_limit 256M
</IfModule>

# ─── Enable compression ──────────────────────────────────────────────
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/css application/javascript application/json image/svg+xml
</IfModule>

# ─── Cache static assets ─────────────────────────────────────────────
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png  "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType text/css   "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
</IfModule>
